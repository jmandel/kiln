<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FHIR Document Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Light theme defaults */
      --bg:#f7f9fc; --card:#ffffff; --muted:#5c6b7a; --text:#0b0e10; --brand:#0ea5e9;
      --chip:#eef2f7; --accent:#22c55e; --warn:#b45309; --border:#d6dee7;
      --focus:#0ea5e9; --code:#f1f5f9; --link:#0b6bcb;
      --header-h:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;padding-top:var(--header-h)}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{display:grid;grid-template-columns:280px 1fr}
    header.topbar{
      position:fixed;top:0;left:0;right:0;z-index:40;
      display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;
      padding:.75rem 1rem;background:linear-gradient(180deg,#ffffff 0%,#ffffffcc 100%);
      border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)
    }
    .brand{font-weight:700;letter-spacing:.2px}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .controls input[type="text"]{min-width:280px}
    .controls input[type="text"], .controls input[type="url"], .controls .button, .controls label.button{
      background:var(--card);border:1px solid var(--border);color:var(--text);padding:.5rem .65rem;border-radius:.5rem
    }
    .controls .button{cursor:pointer}
    .controls input[type="file"]{display:none}
    .grow{flex:1}
    .layout{
      display:grid;grid-template-columns:280px 1fr;gap:0
    }
    aside.nav{
      position:sticky;top:var(--header-h);height:calc(100dvh - var(--header-h));overflow:auto;padding:1rem;border-right:1px solid var(--border);background:#f0f4f8
    }
    .nav h3{margin:.75rem 0 .5rem;font-size:.9rem;color:var(--muted)}
    .nav .group{margin-bottom:1rem}
    .nav ul{list-style:none;margin:0;padding:0}
    .nav li{margin:0}
    .nav a{display:block;padding:.35rem .5rem;border-radius:.35rem;color:var(--text)}
    .nav a:hover{background:var(--card)}
    main.content{padding:1rem 1rem 4rem;min-width:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:.75rem;padding:1rem;margin-bottom:1rem}
    .meta{display:flex;gap:1rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem}
    .headerSummary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.5rem;align-items:flex-start;margin-bottom:.5rem}
    .headerSummary .segment{min-width:0}
    .headerSummary .segment-document{grid-column:1 / -1}
    .headerSummary .label{text-transform:uppercase;font-size:.72rem;letter-spacing:.08em;color:var(--muted);margin-bottom:.2rem}
    .headerSummary .value{font-size:1.25rem;font-weight:600;margin-bottom:.15rem;color:var(--text)}
    .headerSummary .aux{color:var(--muted);font-size:.9rem;line-height:1.4}
    @media (max-width: 640px){
      .headerSummary{grid-template-columns:1fr}
    }
    .section{
      scroll-margin-top:calc(var(--header-h) + 16px);margin-bottom:1.25rem;border:1px dashed var(--border);border-radius:.75rem;padding:1rem;background:#f7f9fc
    }
    .section h4{margin:0 0 .5rem}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:.4ch;padding:.15rem .45rem;
      background:var(--chip);border:0;border-radius:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:.85em;color:var(--text)
    }
    .chip .rt{opacity:.7}
    .resource{
      scroll-margin-top:calc(var(--header-h) + 16px)
    }
    .rhead{
      display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.5rem
    }
    .rtitle{font-weight:700}
    .rtitle small{color:var(--muted);font-weight:500}
    .tabGroup{display:flex;align-items:center;gap:.35rem}
    .tabs{display:flex;gap:.25rem;border:1px solid var(--border);background:var(--bg);border-radius:.5rem;padding:.25rem;cursor:pointer}
    .tab{padding:.25rem .5rem;border-radius:.35rem;border:1px solid transparent;cursor:pointer;background:transparent;color:inherit;font:inherit}
    .tab[aria-selected="true"]{background:var(--card);border-color:var(--border)}
    .copyBtn{border:1px solid var(--border);background:var(--card);color:var(--muted);padding:.35rem;border-radius:.5rem;display:inline-flex;align-items:center;justify-content:center;transition:background .2s,border-color .2s,color .2s,transform .2s;cursor:pointer}
    .copyBtn:hover{background:var(--bg);color:var(--text)}
    .copyBtn svg{width:1rem;height:1rem;display:block}
    .copyBtn.copied{background:var(--accent);border-color:var(--accent);color:#f8fafc;animation:copyPulse .5s ease-out}
    .copyBtn.copied:hover{color:#f8fafc}
    @keyframes copyPulse{
      0%{transform:scale(1)}
      40%{transform:scale(1.1)}
      100%{transform:scale(1)}
    }
    pre.json{background:var(--code);color:var(--text);border:1px solid var(--border);border-radius:.5rem;padding:.75rem;overflow:auto;max-height:60vh}
    code.kv{background:var(--chip);padding:.1rem .3rem;border:1px solid var(--border);border-radius:.3rem}
    .kvrow{display:flex;gap:.6rem;align-items:baseline;white-space:nowrap}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:.65rem}
    .kvlist{display:flex;flex-wrap:wrap;gap:.75rem 1.5rem}
    .bigRow{display:flex;align-items:baseline;justify-content:flex-start;flex-wrap:wrap;column-gap:.75rem;row-gap:.1rem;margin-bottom:.25rem}
    .bigLabel{font-weight:600;font-size:1.05rem}
    .bigValue{font-weight:600;font-size:1.05rem}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:1.25rem 0}
    .btnlink{background:none;border:0;color:var(--link);cursor:pointer}
    .badge{display:inline-block;padding:0;border:0;border-radius:0;background:transparent;color:var(--muted);font-size:.85em}
    .hint{font-size:.9em;color:var(--muted)}
    .error{color:#ffd0d0}
    .search{display:flex;gap:.5rem;align-items:center;margin:.5rem 0 1rem}
    .stickyTop{position:sticky;top:var(--header-h);z-index:30;background:var(--bg);padding:.25rem 0}
    /* Vitals */
    .vitalsCard h3{margin:.1rem 0 .4rem}
    .vtable{width:100%;border-collapse:collapse}
    .vtable th{font-weight:600;color:var(--muted);text-align:left;font-size:.9em;padding:.25rem .25rem}
    .vtable td{padding:.25rem .25rem;vertical-align:middle;border-top:1px solid var(--border)}
    .vtable tr:first-child td{border-top:0}
    .bpCell{display:flex;align-items:baseline;gap:.35rem}
    .bpStack{display:flex;flex-direction:column;line-height:1.05}
    .bpStack .top{font-weight:600}
    .bpStack .bottom{opacity:.9}
    .unit{color:var(--muted);font-size:.85em}
    .interp{display:inline-flex;align-items:center;gap:.25rem;margin-left:.25rem}
    .interp .chip{padding:.05rem .35rem}
    .reflist{margin-top:.25rem}
    .refRows{display:flex;flex-direction:column;gap:.35rem}
    @media (max-width: 980px){
      .app,.layout{grid-template-columns:1fr}
      aside.nav{position:static;height:auto;order:2;border-right:none;border-top:1px solid var(--border)}
    }
    @media print{
      header.topbar, aside.nav, .stickyTop, .controls {display:none !important}
      body{background:white;color:black}
      .card, .section{border-color:#999}
      .tabs{display:none}
      .summary, .jsonview{display:block !important}
      pre.json{max-height:none}
      a{color:inherit;text-decoration:none}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">FHIR Document Viewer</div>
    <div class="controls">
      <select id="exampleSelect" class="button" title="Load example" style="display:none">
        <option value="">Examples‚Ä¶</option>
      </select>
      <label class="button" title="Open a local Bundle (JSON)">
        <input id="fileInput" type="file" accept=".json,application/json" />
        Open File‚Ä¶
      </label>
      <button id="pasteBtn" class="button" title="Paste raw JSON">Paste JSON‚Ä¶</button>
      <input id="urlInput" type="url" placeholder="Load from URL (https://‚Ä¶/bundle.json)" />
      <button id="loadUrlBtn" class="button">Load URL</button>
      <input id="search" type="text" placeholder="Search resources‚Ä¶" />
      <button id="openBundleJsonBtn" class="button" title="Open current Bundle JSON in a new tab">Open Bundle JSON</button>
    </div>
    <div class="grow"></div>
    
  </header>

  <div id="root"></div>
  <div id="pasteModal" style="display:none"></div>

  <!-- React UMD + Babel for in-browser JSX compilation -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState, useRef } = React;
    const { createRoot } = ReactDOM;

    // ---------- Utilities ----------
    const isObj = (v) => v && typeof v === "object";
    const fmtDate = (v) => {
      if (!v) return "";
      try {
        const d = new Date(v);
        if (isNaN(d)) return v;
        return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: v.includes("T") ? "short" : undefined }).format(d);
      } catch { return v; }
    };
    const ccDisplay = (cc) => {
      if (!cc) return "";
      if (cc.text) return cc.text;
      const c = (cc.coding && cc.coding[0]) || {};
      return c.display || [c.system, c.code].filter(Boolean).join(" | ");
    };

    const renderCodeableConcept = (cc, fallback = '') => {
      if (!cc) return fallback || '‚Äî';
      const text = ccDisplay(cc);
      if (cc.coding?.length > 1) {
        const extra = cc.coding.slice(1).map((c, i) => (
          <span key={i} className="muted" style={{marginLeft:'.4rem'}}>
            {c.display || c.code || c.system}
          </span>
        ));
        return (
          <span>
            {text}
            {extra.length ? <span className="muted" style={{marginLeft:'.4rem'}}>+{extra.length} more</span> : null}
          </span>
        );
      }
      return text || fallback || '‚Äî';
    };
    const getSearchParam = (k) => {
      try{ return new URL(window.location.href).searchParams.get(k); } catch { return null; }
    };
    const setSearchParam = (k, v) => {
      try{
        const u = new URL(window.location.href);
        if (v==null || v==='') u.searchParams.delete(k); else u.searchParams.set(k, v);
        window.history.replaceState({}, '', u.toString());
      } catch {}
    };
    const fmtRange = (start, end) => {
      const s = fmtDate(start);
      const e = fmtDate(end);
      if (s && e) return `${s} ‚Üí ${e}`;
      return s || e || "";
    };
    const numberFormatter = new Intl.NumberFormat(undefined, {
      maximumFractionDigits: 2,
      minimumFractionDigits: 0,
    });

    const qtyDisplay = (q) => {
      if (!q) return "";
      let num = q.value;
      if (typeof num === "number") {
        num = numberFormatter.format(num);
      } else if (num == null) {
        num = '';
      }
      const unit = q.unit || q.code || '';
      return [num, unit].filter(Boolean).join(' ');
    };
    const humanName = (p) => {
      if (!p?.name || !p.name[0]) return "";
      const n = p.name[0];
      return [n.prefix?.join(" "), n.given?.join(" "), n.family].filter(Boolean).join(" ").replace(/\s+/g," ").trim();
    };
    const formatGender = (g) => g ? g.charAt(0).toUpperCase() + g.slice(1) : "";
    const calcAgeYears = (birthDate, asOfDate) => {
      if (!birthDate) return null;
      const birth = new Date(birthDate);
      if (Number.isNaN(birth.getTime())) return null;
      const ref = asOfDate ? new Date(asOfDate) : new Date();
      if (Number.isNaN(ref.getTime())) return null;
      let age = ref.getFullYear() - birth.getFullYear();
      const monthDiff = ref.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && ref.getDate() < birth.getDate())) age--;
      return age >= 0 ? age : null;
    };
    const selectIdentifier = (resource, preferCodes = []) => {
      const ids = Array.isArray(resource?.identifier) ? resource.identifier : [];
      if (!ids.length) return null;
      const match = ids.find((id) => {
        const coding = Array.isArray(id?.type?.coding) ? id.type.coding : [];
        return coding.some((c) => preferCodes.includes(c.code));
      }) || ids[0];
      if (!match?.value) return null;
      const assigner = match.assigner?.display || match.assigner?.reference || "";
      return assigner ? `${match.value} (${assigner})` : match.value;
    };
    const sanitizeHTML = (html) => {
      if (!html) return "";
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      tmp.querySelectorAll("script,style").forEach(n => n.remove());
      tmp.querySelectorAll("*").forEach(el => {
        [...el.attributes].forEach(a => {
          if (/^on/i.test(a.name)) el.removeAttribute(a.name);
        });
      });
      // Remove placeholder tokens like {{Plan}} or {{# Supportive Care}}
      tmp.innerHTML = tmp.innerHTML.replace(/\{\{[^}]+\}\}/g, "");
      return tmp.innerHTML;
    };

    const fallbackCopyText = (text) => {
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch {
        return false;
      }
    };

    const copyTextToClipboard = (text, onSuccess) => {
      const done = () => {
        if (typeof onSuccess === 'function') onSuccess();
      };
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(done).catch(() => {
          if (fallbackCopyText(text)) done();
        });
      } else if (fallbackCopyText(text)) {
        done();
      }
    };

    function buildIndex(bundle){
      const byKey = new Map();
      const byFullUrl = new Map();
      const all = [];
      for (const e of bundle.entry || []) {
        if (!e?.resource) continue;
        const r = e.resource;
        const key = `${r.resourceType}/${r.id || ""}`;
        r.__anchor = r.__anchor || key;
        byKey.set(key, r);
        if (e.fullUrl) byFullUrl.set(e.fullUrl, r);
        all.push(r);
      }
      const composition = all.find(r => r.resourceType === "Composition");
      return { byKey, byFullUrl, all, composition };
    }

    function resolveReference(ref, index){
      if (!ref) return null;
      if (!index) return null;
      if (index.byKey.has(ref)) return index.byKey.get(ref);
      if (index.byFullUrl.has(ref)) return index.byFullUrl.get(ref);
      if (/^https?:/.test(ref)) {
        try {
          const u = new URL(ref);
          const parts = u.pathname.split("/").filter(Boolean);
          const key = `${parts[parts.length-2]}/${parts[parts.length-1]}`;
          if (index.byKey.has(key)) return index.byKey.get(key);
        } catch {}
      }
      return null;
    }

    function collectReferences(resource){
      const out = [];
      const seen = new Set();
      const walk = (node, path="")=>{
        if (Array.isArray(node)) return node.forEach((v,i)=>walk(v, `${path}[${i}]`));
        if (!isObj(node)) return;
        for (const [k,v] of Object.entries(node)){
          if (k === "reference" && typeof v === "string"){
            if (!seen.has(v)){ out.push({ref:v, path: path ? `${path}.${k}` : k}); seen.add(v); }
          } else {
            walk(v, path ? `${path}.${k}` : k);
          }
        }
      };
      walk(resource,"");
      return out;
    }

    const resourceKey = (r)=> `${r.resourceType}/${r.id || ""}`;

    const resourceAnchor = (resourceOrRef, fallbackType) => {
      if (!resourceOrRef) return null;
      let key;
      let type;
      let id;

      if (typeof resourceOrRef === 'string') {
        key = resourceOrRef;
        if (resourceOrRef.includes('/')) {
          const parts = resourceOrRef.split('/');
          type = parts[0] || fallbackType || 'Resource';
          id = parts.slice(1).join('/') || resourceOrRef;
        } else {
          type = fallbackType || 'Resource';
          id = resourceOrRef;
        }
      } else {
        key = resourceKey(resourceOrRef);
        type = resourceOrRef.resourceType || fallbackType || key.split('/')[0] || 'Resource';
        id = resourceOrRef.id || key.split('/').pop() || key;
      }

      return <a href={`#${key}`}>{`${type}/${id}`}</a>;
    };

    const referenceAnchor = (ref, index, fallbackType) => {
      if (!ref) return null;
      const target = typeof ref === 'string' ? resolveReference(ref, index) : null;
      return resourceAnchor(target ?? ref, fallbackType);
    };

    function resourceSummaryText(r){
      const parts=[r.resourceType, r.id];
      switch(r.resourceType){
        case "Patient": parts.push(humanName(r), r.gender, r.birthDate); break;
        case "Practitioner": parts.push(humanName(r)); break;
        case "Condition": parts.push(ccDisplay(r.code), r.clinicalStatus?.coding?.[0]?.display); break;
        case "Observation": parts.push(ccDisplay(r.code), qtyDisplay(r.valueQuantity), r.valueString, ccDisplay(r.valueCodeableConcept)); break;
        case "ServiceRequest": parts.push(ccDisplay(r.code), r.status, r.priority); break;
        case "MedicationRequest": parts.push(ccDisplay(r.medicationCodeableConcept), r.status); break;
        case "MedicationStatement": parts.push(ccDisplay(r.medicationCodeableConcept), r.status); break;
        case "Encounter": parts.push(r.status, ccDisplay(r.class), fmtDate(r.period?.start)); break;
        case "Composition": parts.push(r.title, fmtDate(r.date)); break;
        default: parts.push(JSON.stringify(r.type || r.code || r.title || "").slice(0,80));
      }
      return parts.filter(Boolean).join(" ").toLowerCase();
    }

    // ---------- App ----------
    function App(){
      const [bundle, setBundle] = useState(null);
      const bundleRef = useRef(null);
      const [err, setErr] = useState("");
      const [filter, setFilter] = useState("");
      // Print mode toggle removed; printing still controlled via @media print CSS
      const [examples, setExamples] = useState([]);
      const examplesRef = useRef([]);
      const [showPaste, setShowPaste] = useState(false);
      const [pasteText, setPasteText] = useState("");
      const exampleHref = React.useCallback((item) => item?.url || item?.file || item?.path || null, []);

      // Keep CSS --header-h in sync with actual header height
      useEffect(()=>{
        const updateHeaderVar = ()=>{
          const h = document.querySelector('header.topbar')?.offsetHeight || 56;
          document.documentElement.style.setProperty('--header-h', h + 'px');
        };
        updateHeaderVar();
        window.addEventListener('resize', updateHeaderVar);
        return ()=> window.removeEventListener('resize', updateHeaderVar);
      },[]);

      // Wire up topbar buttons that live outside React root for simplicity
      useEffect(()=>{
        const fileEl = document.getElementById("fileInput");
        const pasteBtn = document.getElementById("pasteBtn");
        const exampleSel = document.getElementById("exampleSelect");
        const urlInput = document.getElementById("urlInput");
        const loadUrlBtn = document.getElementById("loadUrlBtn");
        const searchEl = document.getElementById("search");
        const jsonBtn = document.getElementById("openBundleJsonBtn");

        const onFile = (e)=>{
          const f = e.target.files?.[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = ()=> {
            try { setBundle(JSON.parse(reader.result)); setErr(""); }
            catch(ex){ setErr("Invalid JSON in file."); }
          };
          reader.readAsText(f);
        };
        const onPaste = async ()=>{ setPasteText(""); setShowPaste(true); };
        const onLoadUrl = async ()=>{
          const url = urlInput.value.trim();
          if (!url) return;
          try{
            const res = await fetch(url);
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const json = await res.json();
            setBundle(json); setErr("");
            setSearchParam('src', url);
            // Reflect selection if it matches an example
            try{
              const sel = document.getElementById('exampleSelect');
              const arr = examplesRef.current || [];
              const idx = arr.findIndex(it => exampleHref(it) === url);
              if (sel) sel.value = idx >= 0 ? String(idx) : '';
            }catch{}
          }catch(ex){
            setErr("Failed to load URL: " + ex.message);
          }
        };
        const onSearch = (e)=> setFilter(e.target.value.toLowerCase());
        const onOpenBundleJson = ()=>{
          const b = bundleRef.current;
          if (!b){ alert('Load a Bundle first.'); return; }
          try{
            const txt = JSON.stringify(b, null, 2);
            const blob = new Blob([txt], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank', 'noopener');
            setTimeout(()=>URL.revokeObjectURL(url), 60000);
          } catch(ex){ alert('Unable to open JSON: ' + ex.message); }
        };

        const onExampleChange = async (e)=>{
          const val = e.target.value;
          if (val === "" || val == null) return;
          const idx = Number(val);
          if (isNaN(idx) || idx < 0) return;
          const item = examplesRef.current[idx];
          try{
            if (item?.content) { setBundle(item.content); setErr(""); setSearchParam('src', ''); return; }
            const url = exampleHref(item);
            if (url){
              const res = await fetch(url, {cache:'no-store'});
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const json = await res.json();
              setBundle(json); setErr("");
              setSearchParam('src', url);
              return;
            }
          } catch(ex){ setErr('Failed to load example: ' + ex.message); }
        };


        fileEl.addEventListener("change", onFile);
        pasteBtn.addEventListener("click", onPaste);
        exampleSel.addEventListener("change", onExampleChange);
        loadUrlBtn.addEventListener("click", onLoadUrl);
        searchEl.addEventListener("input", onSearch);
        jsonBtn.addEventListener("click", onOpenBundleJson);

        return ()=> {
          fileEl.removeEventListener("change", onFile);
          pasteBtn.removeEventListener("click", onPaste);
          exampleSel.removeEventListener("change", onExampleChange);
          loadUrlBtn.removeEventListener("click", onLoadUrl);
          searchEl.removeEventListener("input", onSearch);
          jsonBtn.removeEventListener("click", onOpenBundleJson);
        };
      },[exampleHref]);

      // Keep bundle ref up-to-date for handlers outside React tree
      useEffect(()=>{ bundleRef.current = bundle; }, [bundle]);

      // Enable/disable JSON button based on bundle presence
      useEffect(()=>{
        const btn = document.getElementById('openBundleJsonBtn');
        if (btn) btn.disabled = !bundle;
      }, [bundle]);

      // Keep ref in sync so change handler always sees latest examples
      useEffect(()=>{ examplesRef.current = examples; }, [examples]);

      // If ?src= is present, load that bundle immediately
      useEffect(()=>{
        (async()=>{
          const src = getSearchParam('src');
          if (!src) return;
          try{
            const res = await fetch(src, {cache:'no-store'});
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const json = await res.json();
            setBundle(json); setErr('');
          }catch(ex){ setErr('Failed to load src: ' + ex.message); }
        })();
      },[]);

      // Load examples index (if present) and auto-load first example (unless ?src= provided)
      useEffect(()=>{
        (async ()=>{
          try{
            const ix = await fetch("examples/index.json", {cache:"no-store"});
            const sel = document.getElementById('exampleSelect');
            if (ix.ok) {
              const data = await ix.json();
              const arr = Array.isArray(data.examples) ? data.examples : [];
              setExamples(arr);
              examplesRef.current = arr;
              if (sel) {
                if (arr.length) {
                  sel.innerHTML = '<option value="">Examples‚Ä¶</option>' + arr.map((it, i)=>`<option value="${i}">${it.name}</option>`).join('');
                  sel.style.display = 'inline-block';
                  // If URL has ?src=, try to select matching example; else autoload first
                  const src = getSearchParam('src');
                  if (src){
                    const matchIdx = arr.findIndex(it => exampleHref(it) === src);
                    if (matchIdx >= 0) { try{ sel.value = String(matchIdx); } catch{} }
                  } else if (!bundleRef.current) {
                    const first = arr[0];
                    const u = exampleHref(first);
                    if (first?.content) {
                      setBundle(first.content);
                      try { sel.value = '0'; } catch {}
                      setSearchParam('src', '');
                    } else if (u) {
                      try {
                        const res2 = await fetch(u, {cache:'no-store'});
                        if (res2.ok) { const j2 = await res2.json(); setBundle(j2); setSearchParam('src', u); }
                        try { sel.value = '0'; } catch {}
                      } catch {}
                    }
                    setErr("");
                  }
                } else {
                  sel.style.display = 'none';
                }
              }
            } else if (sel) {
              sel.style.display = 'none';
            }
          } catch {}
        })();
      },[exampleHref]);

      const index = useMemo(()=> bundle ? buildIndex(bundle) : null, [bundle]);
      const filtered = useMemo(()=>{
        if (!bundle) return null;
        if (!filter) return index.all;
        return index.all.filter(r => resourceSummaryText(r).includes(filter));
      }, [index, bundle, filter]);

      return (
        <div className="app">
          {showPaste && (
            <div style={{position:'fixed',inset:0,background:'#0008',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}>
              <div className="card" style={{maxWidth:'720px',width:'90%'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',gap:'.5rem',marginBottom:'.5rem'}}>
                  <strong>Paste Bundle JSON</strong>
                  <button className="button" onClick={()=>setShowPaste(false)}>Close</button>
                </div>
                <textarea style={{width:'100%',height:'40vh'}} value={pasteText} onInput={(e)=>setPasteText(e.target.value)} placeholder="{ &quot;resourceType&quot;: &quot;Bundle&quot;, ... }"></textarea>
                <div style={{display:'flex',gap:'.5rem',justifyContent:'flex-end',marginTop:'.5rem'}}>
                  <button className="button" onClick={()=>{
                    try { const obj = JSON.parse(pasteText); setBundle(obj); setErr(''); setShowPaste(false);} catch(ex){ setErr('Invalid JSON pasted.'); }
                  }}>Load</button>
                </div>
              </div>
            </div>
          )}
          <aside className="nav" aria-label="Navigator">
            <div className="group">
              <h3>Bundle</h3>
              {bundle ? (
                <ul>
                  <li><span className="badge">resourceType</span> <code className="kv">Bundle</code></li>
                  <li><span className="badge">type</span> <code className="kv">{bundle.type || "‚Äî"}</code></li>
                  <li><span className="badge">entries</span> <code className="kv">{bundle.entry?.length ?? 0}</code></li>
                </ul>
              ) : <div className="muted">Load a FHIR Bundle to begin.</div>}
            </div>

            {index?.composition && (
              <div className="group">
                <h3>Composition</h3>
                <ul>
                  <li><a href={"#"+resourceKey(index.composition)}>{index.composition.title || "Composition"}</a></li>
                </ul>
                {index.composition.section?.length ? (
                  <>
                    <h3>Sections</h3>
                    <ul>
                      {index.composition.section.map((s, i)=>(
                        <li key={i}><a href={`#section-${i+1}`}>{s.title || `Section ${i+1}`}</a></li>
                      ))}
                    </ul>
                  </>
                ) : null}
              </div>
            )}

            {bundle && (
              <div className="group">
                <h3>Resources</h3>
                {Object.entries(groupBy((filtered||[]), r=>r.resourceType))
                  .sort(([a],[b]) => a.localeCompare(b))
                  .map(([rt, list])=>(
                    <details key={rt} open>
                      <summary>{rt} <span className="muted">({list.length})</span></summary>
                      <ul>
                        {list.map(r=>(
                          <li key={resourceKey(r)}>
                            <a href={`#${resourceKey(r)}`}>{r.id || "(no id)"} {r.title ? `‚Äî ${r.title}` : ""}</a>
                          </li>
                        ))}
                      </ul>
                    </details>
                ))}
              </div>
            )}
          </aside>

          <main className="content">
            {err && <div className="card error">‚ö†Ô∏è {err}</div>}
            {bundle ? (
              <>
                <BundleHeader bundle={bundle} index={index} />
                {index?.composition && (
                  <CompositionViewer
                    composition={index.composition}
                    index={index}
                  />
                )}

                {/* Vitals Panel */}
                <VitalsPanel resources={index?.all || []} />

                <div className="stickyTop">
                  <div className="search">
                    <span className="muted">Showing {filtered.length} of {index.all.length} resources</span>
                  </div>
                  <div className="divider"></div>
                </div>

                {filtered.map(r=>(
                  <ResourceCard
                    key={resourceKey(r)}
                    resource={r}
                    index={index}
                  />
                ))}
              </>
            ) : (
              <div className="card">
                <h2>Welcome üëã</h2>
                <p>Load a FHIR <code>Bundle</code> (type <code>document</code>) via <strong>Open File</strong>, <strong>Paste JSON</strong>, or <strong>Load URL</strong>. If <code>examples/index.json</code> is present, the first example auto‚Äëloads and you can switch via the selector.</p>
                <p className="hint">This viewer is client‚Äëside only, designed for scrolling and printing. No data leaves your browser.</p>
              </div>
            )}
          </main>
        </div>
      );
    }

    // ---------- Components ----------
    function BundleHeader({bundle, index}){
      const composition = index?.composition;
      const subjectRef = composition?.subject?.reference;
      const encounterRef = composition?.encounter?.reference;
      const custodianRef = composition?.custodian?.reference;
      const patient = subjectRef ? resolveReference(subjectRef, index) : index?.all?.find((r) => r.resourceType === 'Patient');
      const encounter = encounterRef ? resolveReference(encounterRef, index) : index?.all?.find((r) => r.resourceType === 'Encounter');
      const facilityRef = encounter?.serviceProvider?.reference;
      const facility = facilityRef ? resolveReference(facilityRef, index) : null;
      const custodian = custodianRef ? resolveReference(custodianRef, index) : null;

      const docMoment = composition?.date || encounter?.period?.end || encounter?.period?.start || bundle.timestamp;
      const docTitle = composition?.title || 'Clinical Document';
      const docType = composition?.type ? ccDisplay(composition.type) : '';
      const docStatus = composition?.status ? composition.status.charAt(0).toUpperCase() + composition.status.slice(1) : '';
      const docDate = docMoment ? fmtDate(docMoment) : '';

    const inlineList = (items) =>
      items.filter(Boolean).map((item, idx) => (
        <React.Fragment key={idx}>
          {idx > 0 && <span className="muted"> ‚Ä¢ </span>}
          {item}
        </React.Fragment>
      ));

    const resourceIdDetail = (label, resource) => resourceAnchor(resource, label ? label[0].toUpperCase() + label.slice(1) : undefined);

      const patientName = patient ? (humanName(patient) || patient.name?.[0]?.text || '') : '';
      const patientNode = patientName || (patient ? resourceKey(patient) : '‚Äî');
      const patientGender = formatGender(patient?.gender);
      const patientDob = patient?.birthDate ? fmtDate(patient.birthDate) : '';
      const patientAge = calcAgeYears(patient?.birthDate, docMoment);
      const patientMrn = selectIdentifier(patient, ['MR', 'MRN', 'MRN1', 'PI', 'PAT']);
      const patientDetailsParts = [
        patientGender,
        patientDob ? `DOB ${patientDob}${typeof patientAge === 'number' ? ` (${patientAge}y)` : ''}` : (typeof patientAge === 'number' ? `${patientAge}y` : ''),
        patientMrn ? `MRN ${patientMrn}` : '',
        resourceIdDetail('patient', patient),
      ];

      const encClass = encounter?.class?.display || encounter?.class?.code || '';
      const encType = Array.isArray(encounter?.type) && encounter.type[0] ? ccDisplay(encounter.type[0]) : '';
      const encounterTitle = [encClass, encType].filter(Boolean).join(' ‚Ä¢ ') || (encounter ? 'Encounter' : 'Document');
      const encounterNode = encounterTitle || (encounter ? resourceKey(encounter) : '‚Äî');
      const encounterStatus = encounter?.status ? encounter.status.charAt(0).toUpperCase() + encounter.status.slice(1) : '';
      const encounterWhen = encounter?.period ? fmtRange(encounter.period.start, encounter.period.end) : docDate;
      const encounterReason = Array.isArray(encounter?.reasonCode) && encounter.reasonCode[0] ? ccDisplay(encounter.reasonCode[0]) : '';
      const facilityName = facility ? (facility.name || humanName(facility) || resourceKey(facility)) : (encounter?.serviceProvider?.display || '');
      const encounterDetailsParts = [
        encounterStatus,
        encounterWhen,
        encounterReason ? `Reason: ${encounterReason}` : '',
        facilityName ? `Facility: ${facilityName}` : '',
        resourceIdDetail('encounter', encounter),
        resourceIdDetail('facility', facility),
      ];

      const authorRefs = Array.isArray(composition?.author) ? composition.author : [];
      let providerEntries = authorRefs
        .map((author) => {
          if (author.reference) {
            const r = resolveReference(author.reference, index);
            const name = r ? (humanName(r) || r.name?.text || r.title || resourceKey(r)) : (author.display || author.reference);
            if (!name) return null;
            return { name, resource: r, tag: 'author', prefix: null, detail: null };
          }
          if (author.display) return { name: author.display, resource: null, tag: 'author', prefix: null, detail: null };
          return null;
        })
        .filter(Boolean);
      if (!providerEntries.length && Array.isArray(encounter?.participant)) {
        providerEntries = encounter.participant
          .map((p) => {
            const refRef = p.individual?.reference || p.actor?.reference;
            const ref = refRef ? resolveReference(refRef, index) : null;
            const role = Array.isArray(p.type) && p.type[0] ? ccDisplay(p.type[0]) : '';
            const display = p.individual?.display || p.actor?.display || '';
            const name = ref ? (humanName(ref) || ref.name?.text || resourceKey(ref)) : display;
            if (!name) return null;
            return { name, resource: ref, detail: role, tag: 'participant', prefix: null };
          })
          .filter(Boolean);
      }

      let providerPrimaryEntry = providerEntries[0] || null;
      const secondaryProviderEntries = providerEntries.slice(1);
      const custodianName = custodian ? (custodian.name || humanName(custodian) || resourceKey(custodian)) : (composition?.custodian?.display || '');
      const custodianEntry = custodianName ? { name: custodianName, resource: custodian, prefix: 'Facility', tag: 'facility', detail: null } : null;
      if (!providerPrimaryEntry && custodianEntry) {
        providerPrimaryEntry = custodianEntry;
      } else if (custodianEntry) {
        secondaryProviderEntries.push(custodianEntry);
      }

      const describeProvider = (entry) => {
        if (!entry) return '';
        let label = entry.name;
        if (entry.prefix) label = `${entry.prefix}: ${label}`;
        else if (entry.detail) label = `${label} (${entry.detail})`;
        return label;
      };

      const providerPrimaryNode = providerPrimaryEntry ? describeProvider(providerPrimaryEntry) : '‚Äî';
      const secondaryProviderNodesRaw = secondaryProviderEntries
        .map((entry) => {
          const label = describeProvider(entry);
          if (!label && !entry.resource) return null;
          if (entry.resource) {
            const link = resourceIdDetail(entry.tag || entry.resource?.resourceType || 'Resource', entry.resource);
            return link ? (
              <span>
                {label && <span>{label} </span>}
                {link}
              </span>
            ) : label;
          }
          return label;
        })
        .filter(Boolean);
      const authorDetailsParts = [resourceIdDetail('author', providerPrimaryEntry?.resource), ...secondaryProviderNodesRaw].filter(Boolean);

      const docNode = docTitle;
      const docDetailsParts = [
        docType,
        docStatus ? `Status: ${docStatus}` : '',
        docDate ? `Finalized ${docDate}` : '',
        resourceIdDetail('composition', composition),
      ];

      const bundleIdent = bundle.identifier ? [bundle.identifier.system, bundle.identifier.value].filter(Boolean).join(' ‚Ä¢ ') : '';
      const entryCount = bundle.entry?.length ?? 0;

      return (
        <div className="card">
          <div className="headerSummary">
            <div className="segment segment-document">
              <div className="label">Document</div>
              <div className="value">{docNode}</div>
              {docDetailsParts.some(Boolean) && <div className="aux">{inlineList(docDetailsParts)}</div>}
            </div>
            <div className="segment">
              <div className="label">Patient</div>
              <div className="value">{patientNode}</div>
              {patientDetailsParts.some(Boolean) && <div className="aux">{inlineList(patientDetailsParts)}</div>}
            </div>
            <div className="segment">
              <div className="label">Encounter</div>
              <div className="value">{encounterNode}</div>
              {encounterDetailsParts.some(Boolean) && <div className="aux">{inlineList(encounterDetailsParts)}</div>}
            </div>
            <div className="segment">
              <div className="label">Author</div>
              <div className="value">{providerPrimaryNode}</div>
              {authorDetailsParts.some(Boolean) ? <div className="aux">{inlineList(authorDetailsParts)}</div> : null}
            </div>
          </div>
          <div className="divider"></div>
          <div className="meta">
            {bundle.id && <div><span className="badge">Bundle ID</span> <code className="kv">{bundle.id}</code></div>}
            {bundleIdent && <div><span className="badge">Identifier</span> <span>{bundleIdent}</span></div>}
            {bundle.timestamp && <div><span className="badge">Received</span> <span>{fmtDate(bundle.timestamp)}</span></div>}
            <div><span className="badge">Entries</span> <code className="kv">{entryCount}</code></div>
          </div>
        </div>
      );
    }

    function CompositionViewer({composition, index}){
      const [showJSON, setShowJSON] = useState(false);
      const [copied, setCopied] = useState(false);
      const copyTimerRef = useRef(null);
      const subject = composition.subject?.reference && resolveReference(composition.subject.reference, index);
      const encounter = composition.encounter?.reference && resolveReference(composition.encounter.reference, index);
      const jsonText = useMemo(
        () => JSON.stringify(composition, (k, v) => (k === '__anchor' ? undefined : v), 2),
        [composition]
      );

      useEffect(() => {
        return () => {
          if (copyTimerRef.current) clearTimeout(copyTimerRef.current);
        };
      }, []);

      const handleCopy = () => {
        const finalize = () => {
          setCopied(true);
          if (copyTimerRef.current) clearTimeout(copyTimerRef.current);
          copyTimerRef.current = setTimeout(() => setCopied(false), 500);
        };
        copyTextToClipboard(jsonText, finalize);
      };

      return (
        <div className="card resource" id={resourceKey(composition)}>
          <div className="rhead">
            <div className="rtitle">Composition <small>{composition.title || ""}</small></div>
            <div className="tabGroup">
              <div
                className="tabs"
                role="group"
                aria-label="Toggle JSON"
                onClick={() => setShowJSON((v) => !v)}
                title="Toggle summary / JSON"
              >
                <button className="tab" aria-selected={!showJSON}>Summary</button>
                <button className="tab" aria-selected={showJSON}>JSON</button>
              </div>
              <button
                className={`copyBtn${copied ? ' copied' : ''}`}
                aria-label="Copy composition JSON"
                title={copied ? 'Copied!' : 'Copy composition JSON'}
                onClick={(e) => {
                  e.stopPropagation();
                  handleCopy();
                }}
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
          </div>
          <div className="summary" style={{display: showJSON ? 'none' : 'block'}}>
            <div className="muted" style={{marginBottom:'.5rem'}}>{fmtDate(composition.date)}</div>
            <div className="grid" style={{marginBottom:".5rem"}}>
              <div className="kvrow"><span className="badge">status</span> <code className="kv">{composition.status || "‚Äî"}</code></div>
              {subject && <div className="kvrow"><span className="badge">subject</span> {resourceAnchor(subject, 'Subject')}</div>}
              {encounter && <div className="kvrow"><span className="badge">encounter</span> {resourceAnchor(encounter, 'Encounter')}</div>}
              {composition.author?.length ? (
                <div className="kvrow"><span className="badge">author</span> <span>
                  {composition.author.map((a,i)=>{
                    const r = a.reference && resolveReference(a.reference, index);
                    const link = r ? resourceAnchor(r) : resourceAnchor(a.reference || '', 'Author');
                    return <span key={i} style={{marginRight:".5rem"}}>{link || (a.display || a.reference)}</span>;
                  })}
                </span></div>
              ) : null}
            </div>

            {composition.section?.length ? (
              <>
                <div className="divider"></div>
                <h3 style={{margin:"0 0 .5rem"}}>Sections</h3>
                {composition.section.map((s, i) => (
                  <SectionBlock key={i} s={s} i={i} index={index} />
                ))}
              </>
            ) : <div className="muted">No sections.</div>}
          </div>
          <div className="jsonview" style={{display: showJSON ? 'block' : 'none'}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:".5rem"}}>
              <span className="muted">Pretty‚Äëprinted JSON</span>
              {copied && <span className="badge" role="status">Copied</span>}
            </div>
            <pre className="json"><code>{jsonText}</code></pre>
          </div>
        </div>
      );
    }

    function SectionBlock({s, i, index}){
      const html = sanitizeHTML(s.text?.div || "");
      return (
        <section className="section" id={`section-${i+1}`}>
          <h4>{s.title || `Section ${i+1}`}</h4>
          {html ? <div dangerouslySetInnerHTML={{__html: html}}></div> : <div className="muted">No narrative.</div>}
          {s.entry?.length ? (
            <>
              <div style={{height:".5rem"}}></div>
              <div aria-label="Section entries">
                <ReferencesList refs={s.entry.map((ent)=>({ref: ent.reference || ent.display}))} index={index} />
              </div>
            </>
          ) : null}
        </section>
      );
    }

    function RefChip({r}){
      return <a className="chip" href={`#${resourceKey(r)}`} title={resourceKey(r)}>
        <span className="rt">{r.resourceType}</span><strong>{r.id || "(no id)"}</strong>
      </a>;
    }

    function ReferencesList({refs, index}){
      const order = [
        'Subject','Patient','Encounter','Practitioner','Condition','Observation','ServiceRequest','MedicationRequest','MedicationStatement','Procedure','Composition'
      ];
      const resolved = [];
      const unresolved = [];
      for (const rr of refs) {
        const target = resolveReference(rr.ref, index);
        if (target) {
          resolved.push(target);
        } else if (rr.ref) {
          unresolved.push(rr.ref);
        }
      }
      const sorted = resolved.sort((a, b) => {
        const aIdx = order.indexOf(a.resourceType);
        const bIdx = order.indexOf(b.resourceType);
        return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx) || resourceKey(a).localeCompare(resourceKey(b));
      });

      return (
        <div className="refRows">
          {sorted.map((target) => {
            const key = resourceKey(target);
            const link = resourceAnchor(target);
            return link ? (
              <div key={key}>{link}</div>
            ) : null;
          })}
          {unresolved.map((ref, idx) => (
            <div className="kvrow" key={`unresolved-${idx}`}>
              <span className="muted">Unresolved</span>
              <span className="muted">{ref}</span>
            </div>
          ))}
        </div>
      );
    }

    function ResourceCard({resource, index}){
      const [showJSON, setShowJSON] = useState(false);
      const [copied, setCopied] = useState(false);
      const copyTimerRef = useRef(null);
      const refs = useMemo(()=> collectReferences(resource), [resource]);

      useEffect(()=>{
        return ()=>{
          if (copyTimerRef.current) clearTimeout(copyTimerRef.current);
        };
      },[]);

      const handleCopy = () => {
        const txt = JSON.stringify(resource, (k, v) => (k === '__anchor' ? undefined : v), 2);
        const finalize = () => {
          setCopied(true);
          if (copyTimerRef.current) clearTimeout(copyTimerRef.current);
          copyTimerRef.current = setTimeout(()=>setCopied(false), 500);
        };
        copyTextToClipboard(txt, finalize);
      };

      const Summary = renderSummary(resource, index);

      return (
        <article className="card resource" id={resourceKey(resource)} aria-label={`${resource.resourceType} ${resource.id || ""}`}>
          <div className="rhead">
            <div className="rtitle">{resource.resourceType} {resource.id && <small>‚Äî {resource.id}</small>}</div>
            <div className="tabGroup">
              <div
                className="tabs"
                role="group"
                aria-label="Toggle JSON"
                onClick={()=>setShowJSON(v=>!v)}
                title="Toggle summary / JSON"
              >
                <button className="tab" aria-selected={!showJSON}>Summary</button>
                <button className="tab" aria-selected={showJSON}>JSON</button>
              </div>
              <button
                className={`copyBtn${copied ? ' copied' : ''}`}
                aria-label="Copy resource JSON"
                title={copied ? 'Copied!' : 'Copy resource JSON'}
                onClick={(e)=>{ e.stopPropagation(); handleCopy(); }}
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
          </div>

          <div className="summary" style={{display: showJSON ? 'none' : 'block'}}>
            {Summary}
            {refs.length ? (
              <>
                <div className="divider"></div>
                <div className="kvrow"><span className="badge">references</span></div>
                <ReferencesList refs={refs} index={index} />
              </>
            ) : null}
          </div>

          <div className="jsonview" style={{display: showJSON ? "block" : "none"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:".5rem"}}>
              <span className="muted">Pretty‚Äëprinted JSON</span>
              {copied && <span className="badge" role="status">Copied</span>}
            </div>
            <pre className="json"><code>{JSON.stringify(resource, (k, v) => k === '__anchor' ? undefined : v, 2)}</code></pre>
          </div>

          <div style={{display:"flex",justifyContent:"space-between",marginTop:".5rem"}}>
            <a href={`#${resourceKey(resource)}`} className="muted">Permalink</a>
            <span className="muted">{resourceKey(resource)}</span>
          </div>
        </article>
      );
    }

    function renderSummary(r, index){
      switch(r.resourceType){
        case "Patient": return <PatientSummary r={r} />;
        case "Practitioner": return <PractitionerSummary r={r} />;
        case "Encounter": return <EncounterSummary r={r} />;
        case "Condition": return <ConditionSummary r={r} />;
        case "Observation": return <ObservationSummary r={r} />;
        case "ServiceRequest": return <ServiceRequestSummary r={r} />;
        case "MedicationRequest": return <MedicationRequestSummary r={r} />;
        case "MedicationStatement": return <MedicationStatementSummary r={r} />;
        case "Procedure": return <ProcedureSummary r={r} />;
        case "Composition": return <CompositionSummary r={r} index={index} />;
        default: return <GenericKV r={r} />;
      }
    }

    const KV = ({k,v}) => (
      <div className="kvrow"><span className="badge">{k}</span> <span>{v ?? <span className="muted">‚Äî</span>}</span></div>
    );

    function GenericKV({r, extras={}}){
      const base = [
        ["id", r.id],
        ["status", r.status],
        ["intent", r.intent],
        ["priority", r.priority],
        ["category", ccDisplay(r.category)],
        ["code", ccDisplay(r.code)],
        ["type", ccDisplay(r.type)],
        ["title", r.title],
      ].filter(([_,v])=>v!=null && v!=="");
      const ex = Object.entries(extras);
      return (
        <div className="grid">
          {[...base, ...ex].map(([k,v])=> <KV key={k} k={k} v={v} />)}
        </div>
      );
    }

    function PatientSummary({r}){
      const addr = r.address?.[0];
      const age = r.birthDate ? Math.floor((Date.now() - new Date(r.birthDate).getTime())/(365.25*24*60*60*1000)) : null;
      return (
        <>
          <div className="kvlist">
            <KV k="name" v={humanName(r)} />
            <KV k="gender" v={r.gender} />
            <KV k="birthDate" v={fmtDate(r.birthDate)} />
            {age!=null && <KV k="age" v={`${age} y`} />}
            {r.maritalStatus && <KV k="maritalStatus" v={ccDisplay(r.maritalStatus)} />}
          </div>
          {addr && <div style={{marginTop:'.25rem'}}><KV k="address" v={[addr.line?.join(" "), addr.city, addr.state, addr.postalCode, addr.country].filter(Boolean).join(", ")} /></div>}
        </>
      );
    }

    function PractitionerSummary({r}){
      const nm = humanName(r);
      return (
        <div className="kvlist">
          <KV k="name" v={nm} />
          {r.identifier?.length ? <KV k="identifier" v={`${r.identifier[0].system || ""} ${r.identifier[0].value || ""}`} /> : null}
          {r.telecom?.length ? <KV k="telecom" v={r.telecom.map(t=>`${t.system}: ${t.value}`).join(" ‚Ä¢ ")} /> : null}
          <KV k="gender" v={r.gender} />
        </div>
      );
    }

    function EncounterSummary({r}){
      const title = ccDisplay(r.type?.[0]) || ccDisplay(r.class) || 'Encounter';
      const when = fmtRange(r.period?.start, r.period?.end);
      const titleUsedType = !!ccDisplay(r.type?.[0]);
      const classDisp = ccDisplay(r.class);
      const typeDisp = ccDisplay(r.type?.[0]);
      const metaParts = [r.status, titleUsedType ? classDisp : typeDisp].filter(Boolean);
      const meta = metaParts.join(' ‚Ä¢ ');
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{title}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          {meta && <div className="muted" style={{marginBottom:'.25rem'}}>{meta}</div>}
          <div className="kvlist">
            {r.serviceProvider?.reference && <KV k="provider" v={resourceAnchor(r.serviceProvider.reference, 'Organization')} />}
          </div>
        </>
      );
    }

    function ConditionSummary({r}){
      const codeDisp = ccDisplay(r.code);
      const clin = r.clinicalStatus?.coding?.[0]?.display || r.clinicalStatus?.coding?.[0]?.code;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{codeDisp}</div>
            {clin && <div className="bigValue">{clin}</div>}
          </div>
          <div className="kvlist">
            <KV k="verification" v={r.verificationStatus?.coding?.[0]?.display || r.verificationStatus?.coding?.[0]?.code} />
            <KV k="onset" v={fmtDate(r.onsetDateTime)} />
            <KV k="category" v={r.category?.[0]?.coding?.[0]?.display} />
            {r.severity?.coding?.[0] && <KV k="severity" v={r.severity.coding[0].display || r.severity.coding[0].code} />}
          </div>
        </>
      );
    }

    function ObservationSummary({r, index}){
      const codeText = ccDisplay(r.code) || r.code?.text || r.id;
      const valueQuantity = r.valueQuantity ? qtyDisplay(r.valueQuantity) : null;
      const valueString = r.valueString || null;
      const valueConcept = r.valueCodeableConcept ? renderCodeableConcept(r.valueCodeableConcept) : null;
      const distinctConcept = valueConcept && valueConcept !== codeText ? valueConcept : null;
      const headlineValue = valueQuantity || valueString || distinctConcept;
      const subjectLink = referenceAnchor(r.subject?.reference, index, 'Subject');
      const encounterLink = referenceAnchor(r.encounter?.reference, index, 'Encounter');
      const performerLinks = (r.performer || [])
        .map((p, i) => referenceAnchor(p.reference, index, 'Performer'))
        .filter(Boolean)
        .map((node, i) => <span key={i} style={{marginRight:'.5rem'}}>{node}</span>);
      const bodySiteText = r.bodySite ? renderCodeableConcept(r.bodySite) : null;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{codeText}</div>
            {headlineValue && <div className="bigValue">{headlineValue}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="effective" v={fmtDate(r.effectiveDateTime || r.effectiveInstant || r.effectivePeriod?.start)} />
            {r.interpretation?.[0] && <KV k="interpretation" v={r.interpretation[0].coding?.[0]?.display || r.interpretation[0].coding?.[0]?.code} />}
            {r.category?.[0] && <KV k="category" v={r.category[0].coding?.[0]?.display} />}
            {distinctConcept && headlineValue !== distinctConcept && <KV k="value" v={distinctConcept} />}
            {bodySiteText && <KV k="bodySite" v={bodySiteText} />}
            {subjectLink && <KV k="subject" v={subjectLink} />}
            {encounterLink && <KV k="encounter" v={encounterLink} />}
            {performerLinks.length ? <KV k="performer" v={performerLinks} /> : null}
          </div>
          {r.component?.length ? (
            <>
              <div className="divider"></div>
              <strong>Components</strong>
              <div className="grid" style={{marginTop:".5rem"}}>
                {r.component.map((c, i)=>(
                  <div key={i} style={{border:"1px solid var(--border)",borderRadius:".5rem",padding:".5rem"}}>
                    <div className="kvrow"><span className="badge">code</span> <span>{ccDisplay(c.code)}</span></div>
                    {c.valueQuantity && <div className="kvrow"><span className="badge">value</span> <span>{qtyDisplay(c.valueQuantity)}</span></div>}
                    {c.valueCodeableConcept && <div className="kvrow"><span className="badge">value</span> <span>{renderCodeableConcept(c.valueCodeableConcept)}</span></div>}
                    {c.valueString && <div className="kvrow"><span className="badge">value</span> <span>{c.valueString}</span></div>}
                  </div>
                ))}
              </div>
            </>
          ) : null}
        </>
      );
    }

    // ---------- Vitals Panel ----------
    function VitalsPanel({resources}){
      const rows = useMemo(()=>collectVitals(resources), [resources]);
      if (!rows.length) return null;
      return (
        <div className="card vitalsCard">
          <h3>Vitals</h3>
          <table className="vtable">
            <thead>
              <tr>
                <th>When</th>
                <th>BP</th>
                <th>HR</th>
                <th>Temp</th>
                <th>RR</th>
                <th>SpO‚ÇÇ</th>
              </tr>
            </thead>
            <tbody>
              {rows.map((row, i)=> (
                <tr key={i}>
                  <td>{fmtDate(row.when)}</td>
                  <td>
                    {row.bp ? (
                      <div className="bpCell">
                        <div className="bpStack">
                          <div className="top">{row.bp.sys ?? '‚Äî'}</div>
                          <div className="bottom">{row.bp.dia ?? '‚Äî'}</div>
                        </div>
                        <div className="unit">{row.bp.unit || ''}</div>
                        {row.bp.interp && <span className="interp">{interpretationBadge(row.bp.interp)}</span>}
                      </div>
                    ) : <span className="muted">‚Äî</span>}
                  </td>
                  <td>
                    {row.hr ? (
                      <>
                        {row.hr.val}{row.hr.unit ? ` ${row.hr.unit}` : ''}
                        {row.hr.interp && <span className="interp">{interpretationBadge(row.hr.interp)}</span>}
                      </>
                    ) : <span className="muted">‚Äî</span>}
                  </td>
                  <td>
                    {row.temp ? (
                      <>
                        {row.temp.val}{row.temp.unit ? ` ${row.temp.unit}` : ''}
                        {row.temp.interp && <span className="interp">{interpretationBadge(row.temp.interp)}</span>}
                      </>
                    ) : <span className="muted">‚Äî</span>}
                  </td>
                  <td>
                    {row.rr ? (
                      <>
                        {row.rr.val}{row.rr.unit ? ` ${row.rr.unit}` : ''}
                        {row.rr.interp && <span className="interp">{interpretationBadge(row.rr.interp)}</span>}
                      </>
                    ) : <span className="muted">‚Äî</span>}
                  </td>
                  <td>
                    {row.spo2 ? (
                      <>
                        {row.spo2.val}{row.spo2.unit ? ` ${row.spo2.unit}` : ''}
                        {row.spo2.interp && <span className="interp">{interpretationBadge(row.spo2.interp)}</span>}
                      </>
                    ) : <span className="muted">‚Äî</span>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function interpretationBadge(interp){
      const cod = interp?.coding?.[0] || {};
      const code = (cod.code || '').toUpperCase();
      const disp = (cod.display || code || '').toString();
      const t = disp || code || '';
      const s = t.toLowerCase();
      const isNormal = code === 'N' || s.includes('normal');
      const isHigh = code === 'H' || code === 'HH' || s.includes('high');
      const isLow = code === 'L' || code === 'LL' || s.includes('low');
      const isAbn = s.includes('abn') || s.includes('abnormal');
      const color = isNormal ? 'var(--accent)' : ((isHigh || isLow || isAbn) ? 'var(--warn)' : 'var(--muted)');
      return <span className="chip" style={{color}}>{disp}</span>;
    }

    function collectVitals(resources){
      if (!Array.isArray(resources)) return [];
      const VITAL_CODES = new Set([
        // Heart rate, Temp, Respiratory rate, SpO2
        '8867-4','8310-5','9279-1','59408-5','2708-6',
        // Blood pressure panel and components
        '85354-9','55284-4','8480-6','8462-4'
      ]);
      const isVitalCategory = (o)=>{
        const cats = (o.category || []).flatMap(c=> (c.coding || []).map(cd => (cd.code || cd.display || '').toLowerCase()));
        return cats.includes('vital-signs') || cats.includes('vital signs');
      };
      const obs = resources.filter(r => r.resourceType === 'Observation' && (
        isVitalCategory(r) || (r.code?.coding || []).some(c => VITAL_CODES.has(c.code))
      ));

      const getWhen = (o)=> o.effectiveDateTime || o.effectiveInstant || o.effectivePeriod?.start || o.issued || o.meta?.lastUpdated || '';
      const rowsByWhen = new Map();
      const ensureRow = (k, when)=>{
        if (!rowsByWhen.has(k)) rowsByWhen.set(k, { when, bp:null, hr:null, temp:null, rr:null, spo2:null });
        return rowsByWhen.get(k);
      };
      const getCodes = (o)=> (o.code?.coding || []).map(c=>c.code);
      const findComp = (o, code)=> (o.component || []).find(c => (c.code?.coding || []).some(cd => cd.code === code));

      for (const o of obs){
        const when = getWhen(o);
        const key = when || (o.id ? `id:${o.id}` : Math.random().toString(36).slice(2));
        const row = ensureRow(key, when);
        const codes = new Set(getCodes(o));
        const interp = o.interpretation?.[0] || null;

        // Blood pressure panel
        if (codes.has('85354-9') || codes.has('55284-4')){
          const sys = findComp(o, '8480-6')?.valueQuantity;
          const dia = findComp(o, '8462-4')?.valueQuantity;
          if (sys || dia){
            row.bp = {
              sys: sys?.value,
              dia: dia?.value,
              unit: (sys?.unit || sys?.code || dia?.unit || dia?.code || 'mmHg'),
              interp
            };
          }
          continue;
        }
        // Individual BP components
        if (codes.has('8480-6') || codes.has('8462-4')){
          const q = o.valueQuantity;
          row.bp = row.bp || { sys:null, dia:null, unit:(q?.unit || q?.code || 'mmHg'), interp };
          if (codes.has('8480-6')) row.bp.sys = q?.value;
          if (codes.has('8462-4')) row.bp.dia = q?.value;
          continue;
        }
        // Heart rate
        if (codes.has('8867-4')){
          const q = o.valueQuantity;
          if (q) row.hr = { val:q.value, unit:(q.unit || q.code || ''), interp };
          continue;
        }
        // Temperature
        if (codes.has('8310-5')){
          const q = o.valueQuantity;
          if (q) row.temp = { val:q.value, unit:(q.unit || q.code || ''), interp };
          continue;
        }
        // Respiratory rate
        if (codes.has('9279-1')){
          const q = o.valueQuantity;
          if (q) row.rr = { val:q.value, unit:(q.unit || q.code || ''), interp };
          continue;
        }
        // SpO2
        if (codes.has('59408-5') || codes.has('2708-6')){
          const q = o.valueQuantity;
          if (q) row.spo2 = { val:q.value, unit:(q.unit || q.code || '%'), interp };
          continue;
        }
      }

      // Create array, sort by when desc, and limit to recent ones
      const arr = [...rowsByWhen.values()].filter(r => r.bp || r.hr || r.temp || r.rr || r.spo2);
      arr.sort((a,b)=>{
        const ta = a.when ? Date.parse(a.when) : 0;
        const tb = b.when ? Date.parse(b.when) : 0;
        return tb - ta;
      });
      return arr.slice(0, 6);
    }

    function ServiceRequestSummary({r}){
      const when =
        r.occurrencePeriod ? fmtRange(r.occurrencePeriod.start, r.occurrencePeriod.end) :
        r.occurrenceDateTime ? fmtDate(r.occurrenceDateTime) :
        (r.occurrenceTiming?.event?.length ? (()=>{
          const ev = r.occurrenceTiming.event;
          const sorted = [...ev].sort();
          return fmtRange(sorted[0], sorted[sorted.length-1]);
        })() : null);
      const meta = [r.status, [r.intent, r.priority].filter(Boolean).join('/')].filter(Boolean).join(' ‚Ä¢ ');
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{ccDisplay(r.code)}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          {meta && <div className="muted" style={{marginBottom:'.25rem'}}>{meta}</div>}
          <div className="kvlist">
            {r.reasonCode?.[0] && <KV k="reason" v={ccDisplay(r.reasonCode?.[0])} />}
          </div>
        </>
      );
    }

    function MedicationRequestSummary({r}){
      const med = ccDisplay(r.medicationCodeableConcept) || r.medicationReference?.reference || "‚Äî";
      const dose = r.dosageInstruction?.[0];
      const sigText = (dose?.text || r.patientInstruction || "").trim() || null;
      const doseQty = (dose?.doseAndRate?.[0]?.doseQuantity && qtyDisplay(dose.doseAndRate[0].doseQuantity)) || null;
      const freq = dose?.timing?.repeat?.frequency && `${dose.timing.repeat.frequency}√ó/${dose.timing.repeat.period}${dose.timing.repeat.periodUnit}`;
      const doseSummary = [doseQty, freq].filter(Boolean).join(" ‚Ä¢ ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{med}</div>
            {doseSummary && <div className="bigValue">{doseSummary}</div>}
          </div>
          {sigText && <div className="muted" style={{marginTop:'.1rem'}}>{sigText}</div>}
          <div className="kvlist">
            <KV k="status" v={r.status} />
            <KV k="intent" v={r.intent} />
            {dose?.route && <KV k="route" v={dose.route.coding?.[0]?.display} />}
            {r.note?.[0]?.text && <KV k="note" v={r.note[0].text} />}
          </div>
        </>
      );
    }

    function MedicationStatementSummary({r}){
      const med = ccDisplay(r.medicationCodeableConcept) || "‚Äî";
      const dose = r.dosage?.[0];
      const sigText = (dose?.text || "").trim() || null;
      const doseQty = (dose?.doseAndRate?.[0]?.doseQuantity && qtyDisplay(dose.doseAndRate[0].doseQuantity)) || null;
      const freq = dose?.timing?.repeat?.frequency && `${dose.timing.repeat.frequency}√ó/${dose.timing.repeat.period}${dose.timing.repeat.periodUnit}`;
      const doseSummary = [doseQty, freq].filter(Boolean).join(" ‚Ä¢ ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{med}</div>
            {doseSummary && <div className="bigValue">{doseSummary}</div>}
          </div>
          {sigText && <div className="muted" style={{marginTop:'.1rem'}}>{sigText}</div>}
          <div className="kvlist">
            <KV k="status" v={r.status} />
            {r.effectivePeriod?.start && <KV k="since" v={fmtDate(r.effectivePeriod.start)} />}
            {r.note?.[0]?.text && <KV k="note" v={r.note[0].text} />}
          </div>
        </>
      );
    }

    function CompositionSummary({r, index}){
      const subjLink = referenceAnchor(r.subject?.reference, index, 'Subject');
      const encLink = referenceAnchor(r.encounter?.reference, index, 'Encounter');
      const meta = [r.status, ccDisplay(r.type)].filter(Boolean).join(" ‚Ä¢ ");
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{r.title || "Composition"}</div>
            {r.date && <div className="bigValue">{fmtDate(r.date)}</div>}
          </div>
          {meta && <div className="muted" style={{marginBottom:".4rem"}}>{meta}</div>}
          <div className="kvlist">
            {subjLink && <KV k="subject" v={subjLink} />}
            {encLink && <KV k="encounter" v={encLink} />}
            {r.author?.length && <KV k="author" v={(r.author || []).map((a,i)=>{
              const link = referenceAnchor(a.reference, index, 'Author');
              return <span key={i} style={{marginRight:".5rem"}}>{link || (a.display || a.reference)}</span>;
            })} />}
          </div>
        </>
      );
    }

    function ProcedureSummary({r}){
      const when = r.performedDateTime ? fmtDate(r.performedDateTime)
        : (r.performedPeriod?.start || r.performedPeriod?.end)
          ? [fmtDate(r.performedPeriod?.start), fmtDate(r.performedPeriod?.end)].filter(Boolean).join(" ‚Üí ")
          : null;
      return (
        <>
          <div className="bigRow">
            <div className="bigLabel">{ccDisplay(r.code) || r.code?.text || r.id}</div>
            {when && <div className="bigValue">{when}</div>}
          </div>
          <div className="kvlist">
            <KV k="status" v={r.status} />
            {r.category && <KV k="category" v={ccDisplay(r.category)} />}
            {r.reasonCode?.[0] && <KV k="reason" v={ccDisplay(r.reasonCode[0])} />}
          </div>
        </>
      );
    }

        
    // ---------- helpers ----------
    function groupBy(items, keyFn){
      const m = {};
      for (const it of items){ const k = keyFn(it); (m[k] = m[k] || []).push(it); }
      return m;
    }

    // ---------- Render ----------
    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
